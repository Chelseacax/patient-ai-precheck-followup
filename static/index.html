<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedBridge — Voice AI Pre-Consultation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
</head>
<body>

<!-- ===== Top Navigation ===== -->
<nav class="topnav">
    <div class="topnav-brand" onclick="navigateTo('home')">
        <svg width="28" height="28" viewBox="0 0 28 28" fill="none"><rect x="2" y="10" width="24" height="8" rx="2" fill="#4f9cf7"/><rect x="10" y="2" width="8" height="24" rx="2" fill="#4f9cf7"/></svg>
        <span>MedBridge</span>
    </div>
    <div class="topnav-links">
        <button class="nav-btn active" data-view="home" onclick="navigateTo('home')">Home</button>
        <button class="nav-btn" data-view="checkin" onclick="navigateTo('checkin')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
            Book Appointment
        </button>
        <button class="nav-btn" data-view="doctor" onclick="navigateTo('doctor')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            Doctor Portal
        </button>
    </div>
</nav>

<!-- ===== API Key Banner ===== -->
<div id="api-key-banner" class="api-key-banner hidden">
    <div class="api-key-banner-content">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span><strong>API key not configured.</strong> Enter your OpenAI or Groq API key to enable AI conversations.</span>
        <div class="api-key-input-group">
            <input type="password" id="api-key-input" placeholder="sk-... or gsk_..." autocomplete="off">
            <button class="btn btn-primary btn-sm" onclick="saveApiKey()">Save Key</button>
        </div>
        <button class="btn btn-icon btn-sm" onclick="dismissBanner()" title="Dismiss" style="opacity:0.6">&times;</button>
    </div>
</div>

<!-- ===== VIEW: Home ===== -->
<section id="view-home" class="view active">
    <div class="hero">
        <div class="hero-content">
            <h1>AI-Powered Voice Pre-Consultation</h1>
            <p class="hero-sub">Patients speak with Aria, our multilingual voice AI, before seeing the doctor. Aria collects symptoms, history, and concerns — then sends a structured clinical summary directly to the Doctor Portal.</p>
        </div>

        <div class="portal-cards">
            <div class="portal-card checkin-card" onclick="navigateTo('checkin')">
                <div class="portal-icon checkin-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                </div>
                <h2>Book Appointment</h2>
                <p>Speak with Aria before your appointment. Share your symptoms and medical history in your own language — completely hands-free.</p>
                <ul class="portal-features">
                    <li>Voice-driven symptom collection</li>
                    <li>18 languages &amp; dialects supported</li>
                    <li>Red-flag screening &amp; clinical summary</li>
                </ul>
                <span class="portal-cta">Book Appointment &rarr;</span>
            </div>
            <div class="portal-card doctor-card" onclick="navigateTo('doctor')">
                <div class="portal-icon doctor-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                </div>
                <h2>Doctor Portal</h2>
                <p>Review structured clinical summaries from patient voice check-ins — with bilingual transcripts and red-flag alerts, all in English.</p>
                <ul class="portal-features">
                    <li>Structured clinical summaries</li>
                    <li>Bilingual conversation transcripts</li>
                    <li>Urgency flags &amp; cultural context</li>
                </ul>
                <span class="portal-cta">Enter Doctor Portal &rarr;</span>
            </div>
        </div>

        <div class="hero-features">
            <div class="feature-card">
                <div class="feature-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                </div>
                <h3>18 Languages &amp; Dialects</h3>
                <p>华语, 福建话, 潮州话, 广东话, Malay, Tamil, and more — with Singapore dialect support</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
                </div>
                <h3>Fully Voice-Driven</h3>
                <p>Aria listens, speaks, and listens again — automatic turn-taking with no buttons required</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                </div>
                <h3>Clinical Summaries</h3>
                <p>Structured reports with chief complaints, medications, red flags, and cultural considerations</p>
            </div>
        </div>
    </div>
</section>

<!-- ===== VIEW: Book Appointment (Voice AI Agent) ===== -->
<section id="view-checkin" class="view">
    <div class="portal-label checkin-label">Book Appointment</div>

    <!-- Step 1: Setup form -->
    <div id="checkin-setup" class="checkin-step active">
        <div class="container-narrow">
            <div class="card card-elevated">
                <div class="checkin-aria-avatar">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                </div>
                <div class="card-header" style="text-align:center">
                    <h2>Meet Aria</h2>
                    <p class="text-muted">Your AI voice assistant. Aria will ask about your symptoms and medical history before your appointment, then send a summary to your doctor.</p>
                </div>
                <form id="form-checkin" onsubmit="handleCheckinSetup(event)">
                    <div class="form-group">
                        <label for="checkin-name">Full Name <span class="required">*</span></label>
                        <input type="text" id="checkin-name" required placeholder="e.g. Ahmad bin Ibrahim" autocomplete="name">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="checkin-dob">Date of Birth</label>
                            <input type="date" id="checkin-dob">
                        </div>
                        <div class="form-group">
                            <label for="checkin-language">Preferred Language <span class="required">*</span></label>
                            <select id="checkin-language" required onchange="updateCheckinDialects()"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="checkin-dialect">Dialect / Variant</label>
                        <select id="checkin-dialect"><option value="">— Select —</option></select>
                    </div>
                    <div class="form-group">
                        <label for="checkin-cultural">Cultural Considerations <span class="text-muted">(optional)</span></label>
                        <textarea id="checkin-cultural" rows="2" placeholder="e.g. Halal dietary requirements; family makes health decisions together…"></textarea>
                    </div>
                    <button type="submit" class="btn btn-checkin btn-block" id="btn-start-checkin">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
                        Book Appointment
                    </button>
                    <p class="text-muted" style="font-size:0.8rem;text-align:center;margin-top:0.75rem;">You can also type your responses if you prefer.</p>
                </form>
            </div>
        </div>
    </div>

    <!-- Step 2: Voice Conversation -->
    <div id="checkin-chat" class="checkin-step">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-header-left">
                    <button class="btn btn-icon" onclick="backToCheckinSetup()" title="Back">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                    </button>
                    <div>
                        <h3 id="checkin-chat-title">Aria — Voice Check-In</h3>
                        <span class="badge checkin-badge" id="checkin-lang-badge">English</span>
                        <span class="badge badge-outline">Pre-Consultation</span>
                    </div>
                </div>
                <div class="checkin-header-actions">
                    <button class="btn btn-icon btn-sm" id="btn-auto-toggle" onclick="toggleAutoMode()" title="Toggle auto voice loop">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
                        <span id="auto-mode-label">Auto On</span>
                    </button>
                    <button class="btn btn-success" id="btn-send-to-doctor" onclick="completeCheckin()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        Send to Doctor
                    </button>
                </div>
            </div>

            <!-- Listening / speaking indicator -->
            <div id="checkin-voice-indicator" class="checkin-voice-indicator hidden">
                <div class="voice-pulse-ring"></div>
                <div class="voice-pulse-ring delay-1"></div>
                <div class="voice-pulse-ring delay-2"></div>
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
                <span id="checkin-voice-status-text">Listening…</span>
            </div>

            <div class="chat-messages" id="checkin-messages"></div>

            <div id="checkin-voice-status" class="voice-status">
                <span class="voice-status-dot"></span>
                <span id="checkin-status-text">Listening…</span>
            </div>

            <div class="chat-input-bar">
                <textarea id="checkin-input" rows="1" placeholder="Type or let Aria listen automatically…" onkeydown="handleCheckinKey(event)" oninput="autoResize(this)"></textarea>
                <button class="btn btn-mic" id="btn-checkin-mic" onclick="toggleCheckinVoice()" title="Speak your response">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                </button>
                <button class="btn btn-primary btn-icon" id="btn-checkin-send" onclick="sendCheckinMessage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Step 3: Summary (shown to patient after sending to doctor) -->
    <div id="checkin-summary" class="checkin-step">
        <div class="container-narrow">
            <div class="card card-elevated checkin-confirm-card">
                <div class="checkin-confirm-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                </div>
                <h2>Sent to Your Doctor!</h2>
                <p class="text-muted">Your check-in summary has been forwarded to the Doctor Portal. Here is a summary of what was shared:</p>
                <div id="checkin-summary-content" class="summary-content"></div>
                <div class="card-actions">
                    <button class="btn btn-checkin" onclick="backToCheckinSetup()">New Booking</button>
                    <button class="btn btn-outline" onclick="navigateTo('home')">Back to Home</button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- ===== VIEW: Doctor Portal ===== -->
<section id="view-doctor" class="view">
    <div class="portal-label doctor-label">Doctor Portal</div>
    <div class="dashboard">
        <div class="dashboard-sidebar">
            <div class="sidebar-header">
                <h3>Book Appointments</h3>
                <button class="btn btn-sm btn-outline" onclick="loadSessions()" title="Refresh list">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    Refresh
                </button>
            </div>
            <div class="sidebar-filters">
                <label class="sidebar-filter-label">Sort by</label>
                <select id="filter-sort" onchange="loadSessions()">
                    <option value="newest">Newest first</option>
                    <option value="name-az">Name (A–Z)</option>
                    <option value="name-za">Name (Z–A)</option>
                </select>
                <label class="sidebar-filter-label">Status</label>
                <select id="filter-status" onchange="loadSessions()">
                    <option value="">All Status</option>
                    <option value="completed">Completed</option>
                    <option value="in_progress">In Progress</option>
                </select>
                <label class="sidebar-filter-label">Priority</label>
                <select id="filter-urgent" onchange="loadSessions()">
                    <option value="">All</option>
                    <option value="urgent">Urgent only</option>
                </select>
            </div>
            <div id="session-list" class="session-list">
                <div class="empty-state">
                    <p>No check-ins yet.</p>
                    <p class="text-muted">Patient voice check-ins appear here once submitted.</p>
                </div>
            </div>
        </div>
        <div class="dashboard-main" id="dashboard-main">
            <div class="empty-state-large">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--color-muted)" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                <h3>Select a Patient</h3>
                <p class="text-muted">Choose a patient check-in from the sidebar to view their clinical summary and voice conversation transcript.</p>
            </div>
        </div>
    </div>
</section>

<!-- ===== Spinner Overlay ===== -->
<div id="spinner-overlay" class="spinner-overlay hidden">
    <div class="spinner"></div>
    <p id="spinner-text">Processing…</p>
</div>

<script src="/app.js"></script>
</body>
</html>
